\subsection{Code-Ablauf}\label{subsec:code-ablauf}

Im Folgenden wird der detaillierte Ablauf im Code dargestellt, der beim Ausnutzen der Schwachstelle abläuft.\\

Der Einstiegspunkt für das Programm ist abhängig vom übergebenen Shell-Befehl in der Kommandozeile.\\

Das konkrete Beispiel wird anhand des "convert"-Befehls erläutert.\\

Hier wird im ImageMagick-Ordner in der Datei utilities/convert.c die main()-Methode ausgeführt und alle Inhalte (Bild, Parameter, ...) übergeben:\\

\begin{lstlisting}[firstnumber=90, language=C, caption=utilities/convert.c Einstieg main(),label={lst:lstlisting}]
int main(int argc,char **argv)
{
  return(ConvertMain(argc,argv));
}
\end{lstlisting}
\vspace{5mm}

Die main()-Methode ruft dann direkt die ConvertMain()-Methode in der selben Datei auf:\\

\begin{lstlisting}[firstnumber=67, language=C, caption=utilities/convert.c ConvertMain(),label={lst:lstlisting}]
static int ConvertMain(int argc,char **argv)
{
  ExceptionInfo
    *exception;

  ImageInfo
    *image_info;

  MagickBooleanType
    status;

  MagickCoreGenesis(*argv,MagickTrue);
  exception=AcquireExceptionInfo();
  image_info=AcquireImageInfo();
  status=MagickCommandGenesis(image_info,ConvertImageCommand,argc,argv,
    (char **) NULL,exception);
  image_info=DestroyImageInfo(image_info);
  exception=DestroyExceptionInfo(exception);
  MagickCoreTerminus();
  return(status != MagickFalse ? 0 : 1);
}
\end{lstlisting}
\vspace{5mm}

In dieser Methode werden die Parameter an die ConvertImageCommand()-Methode übergeben:\\

\begin{lstlisting}[firstnumber=81, language=C, caption=utilities/convert.c Aufruf MagickCommandGenesis(),label={lst:lstlisting}]
  status=MagickCommandGenesis(image_info,ConvertImageCommand,argc,argv,
    (char **) NULL,exception);
\end{lstlisting}
\vspace{5mm}

Die Methode ConvertImageCommand() befindet sich in wand/convert.c und liest ein oder mehrere Bilder ein, führt die Operationen aus und schreibt die neue Datei im passenden Format:\\

\begin{lstlisting}[firstnumber=498, language=C, caption=wand/convert.c ConvertImageCommand(),label={lst:lstlisting}]
WandExport MagickBooleanType ConvertImageCommand(ImageInfo *image_info,
  int argc,char **argv,char **metadata,ExceptionInfo *exception)
{
  ...
}
\end{lstlisting}
\vspace{5mm}

Innerhalb der Methode wird nun die ReadImages()-Methode aufgerufen:\\

\begin{lstlisting}[firstnumber=628, language=C, caption=wand/convert.c Aufruf ReadImages(),label={lst:lstlisting}]
  images=ReadImages(image_info,exception);
\end{lstlisting}
\vspace{5mm}

Die ReadImages()-Methode befindet sich in magick/constitue.c und liest ein oder mehrere Bilder ein und gibt diese innerhalb einer Liste zurück:\\

\begin{lstlisting}[firstnumber=790, language=C, caption=magick/constitute.c ReadImages(),label={lst:lstlisting}]
MagickExport Image *ReadImages(const ImageInfo *image_info,
  ExceptionInfo *exception)
{
  ...
}
\end{lstlisting}
\vspace{5mm}

Jedes einzelne Bild wird dann der ReadImage()-Methode übergeben.\\
Diese liest den Bildinhalt ein:\\

\begin{lstlisting}[firstnumber=352, language=C, caption=magick/constitute.c ReadImage(),label={lst:lstlisting}]
MagickExport Image *ReadImage(const ImageInfo *image_info,
  ExceptionInfo *exception)
{
  ...
}
\end{lstlisting}
\vspace{5mm}

Innerhalb der ReadImage()-Methode wird dann die InvokeDelegate()-Methode aufgerufen:\\

\begin{lstlisting}[firstnumber=523, language=C, caption=magick/constitue.c Aufruf InvokeDelegate(),label={lst:lstlisting}]
  (void) InvokeDelegate(read_info,image,read_info->magick,(char *) NULL,
    exception);
\end{lstlisting}
\vspace{5mm}

Die Methode InvokeDelegate() befindet sich in magick/delegate.c und ersetzt eingebundene Zeichen mit den dazugehörigen Bildattributen:\\

\begin{lstlisting}[firstnumber=1097, language=C, caption=magick/delegate.c InvokeDelegate(),label={lst:lstlisting}]
MagickExport MagickBooleanType InvokeDelegate(ImageInfo *image_info,
  Image *image,const char *decode,const char *encode,ExceptionInfo *exception)
{
\end{lstlisting}
\vspace{5mm}

Innerhalb der InvokeDelegate()-Mathode wird die ExternalDelegateCommand()-Methode aufgerufen:\\

\begin{lstlisting}[firstnumber=1301, language=C, caption=magick/delegate.c Aufruf ExternalDelegateCommand(),label={lst:lstlisting}]
  status=ExternalDelegateCommand(delegate_info->spawn,image_info->verbose,
    command,(char *) NULL,exception) != 0 ? MagickTrue : MagickFalse;
\end{lstlisting}
\vspace{5mm}

Die ExternalDelegateCommand()-Methode befindet sich in der selben Datei und führt das jeweilige Kommando aus:\\

\begin{lstlisting}[firstnumber=346, language=C, caption=magick/delegate.c ExternalDelegateCommand(),label={lst:lstlisting}]
MagickExport int ExternalDelegateCommand(const MagickBooleanType asynchronous,
  const MagickBooleanType verbose,const char *command,char *message,
  ExceptionInfo *exception)
{
  ...
}
\end{lstlisting}
\vspace{5mm}

Innerhalb der ExternalDelegateCommand()-Methode wird die Methode SanitizeDelegateCommand() aufgerufen:\\

\begin{lstlisting}[firstnumber=395, language=C, caption=magick/delegate.c Aufruf SanitizeDelegateCommand(),label={lst:lstlisting}]
  sanitize_command=SanitizeDelegateCommand(command);
\end{lstlisting}
\vspace{5mm}

Die SanitizeDelegateCommand()-Methode bereinigt das übergebene Kommando, filtert also unzulässige Zeichen heraus:\\

\begin{lstlisting}[firstnumber=322, language=C, caption=magick/delegate.c SanitizieDelegateCommand(),label={lst:lstlisting}]
static char *SanitizeDelegateCommand(const char *command)
{
  char
    *sanitize_command;

  const char
    *q;

  register char
    *p;

  static char
    whitelist[] =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_- "
      ".@&;<>()|/\\\'\":%=~`";

  sanitize_command=AcquireString(command);
  p=sanitize_command;
  q=sanitize_command+strlen(sanitize_command);
  for (p+=strspn(p,whitelist); p != q; p+=strspn(p,whitelist))
    *p='_';
  return(sanitize_command);
}
\end{lstlisting}
\vspace{5mm}

Nach dem "Sanitizen" wird dann das bereinigte Kommando an direkt durch die system()-Methode an die Shell übergeben:\\

\begin{lstlisting}[firstnumber=402, language=C, caption=magick/delegate.c Aufruf system(),label={lst:lstlisting}]
  status=system(sanitize_command);
\end{lstlisting}
\vspace{5mm}

Der zum Ausnutzen der Schwachstelle eingefügte Shell-Befehl wird dann ausgeführt.