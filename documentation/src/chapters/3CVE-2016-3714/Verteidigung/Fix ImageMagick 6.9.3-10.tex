\newpage
\section{Verteidigung der Schwachstelle}\label{sec:verteidigung-der-schwachstelle}
\subsection{Fix ImageMagick 6.9.3-10 und 7.0.1-1}\label{subsec:fix-imagemagick-6.9.3-10}

Die Schwachstelle ist für ImageMagick 6 in Version 6.9.3-10~\cite{Fix6A}~\cite{Fix6B} beseitigt.
Für ImageMagick 7 ist mit der Version 7.0.1-1~\cite{Fix7A}~\cite{Fix7B} behoben.\\
Im Folgenden werden die einzelnen Codestellen erläutert, die dafür verantwortlich sind.
Es wird sich an dem Code von ImageMagick 6 orientiert.
Die Änderungen sind jedoch auch bei ImageMagick 7 in denselben Dateien durchgeführt worden.\\

Wie bereits in den Details der Schwachstelle erläutert,
entsteht die Schwachstelle dadurch,
dass man durch geschicktes wählen der URL aus dem \%M-Parameter ausbrechen kann und
somit per Pipe weitere Befehle an den system()-Call übergeben kann.\\

Das Ersetzen der Parameter übernimmt, wie oben beschrieben die Methode\\ GetMagickPropertyLetter()~\cite{DeklarationGetMgickPropertyLetter}.

\begin{lstlisting}[firstnumber=2627, language=C, caption=magick/property.c Ungefilterte Weitergabe M-Parameter,label={lst:lstlisting}]
  case 'M':
  {
    /*
      Magick filename - filename given incl. coder & read mods.
    */
    string=image->magick_filename;
    break;
  }
\end{lstlisting}
\vspace{5mm}

Hier ist ersichtlich, dass der komplette Dateiname inklusive Anführungszeichen gesetzt wird.\\

Die Verteidigung der Schwachstelle ist ab Version 6.9.3-10 so gelöst, dass für das https-Delegate anstatt Parameter "`\%M"' ein neu eingeführter Parameter "`\%F"'~\cite{CompareDelegatexXML} verwendet wird:\\

\begin{lstlisting}[firstnumber=91, language=XML, caption=config/delegates.xml.in https-Delegate 6.9.3-10,label={lst:lstlisting}]
  <delegate decode="https" command="&quot;@WWWDecodeDelegate@&quot; -s -k -L -o &quot;%o&quot; &quot;https:%F&quot;"/>
\end{lstlisting}
\vspace{5mm}

Bereinigt um die Codierung der Anführungszeichen ergibt sich:\\

\begin{lstlisting}[firstnumber=1, language=Bash, caption=Aufgelöster https-Delegate-Befehl 6.9.3-10,label={lst:lstlisting}]
"@WWWDecodeDelegate@" -s -k -L -o "%o" "https:%F"
\end{lstlisting}
\vspace{5mm}

\newpage

Schaut man nun wieder in der GetMagickPropertyLetter()-Methode~\cite{ComareFParam},
erkennt man ähnlichen Code wie in der SanitizeDelegateCommand()-Methode.

\begin{lstlisting}[firstnumber=2610, language=C, caption=magick/property.c Gefilterte Wietergabe F-Parameter,label={lst:lstlisting}]
  case 'F':
  {
    const char
      *q;

    register char
      *p;

    static char
      whitelist[] =
        "^-ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
        "+&@#/%?=~_|!:,.;()";

    /*
      Magick filename (sanitized) - filename given incl. coder & read mods.
    */
    (void) CopyMagickString(value,image->magick_filename,MaxTextExtent);
    p=value;
    q=value+strlen(value);
    for (p+=strspn(p,whitelist); p != q; p+=strspn(p,whitelist))
      *p='_';
    break;
  }
\end{lstlisting}
\vspace{5mm}

Es fällt auf, dass die Anführungszeichen "' und ' nicht in der Whitelist enthalten sind.
Das hat zur Folge, dass der Filename nicht mehr, wie zuvor einfach weitergereicht, sondern um Anführungszeichen bereinigt wird.\\

Dadurch ist es nicht mehr möglich aus dem URL-Argument des HTTPS-Delegate Commands auszubrechen und weitere Befehle per Pipe hinter der URL anzugeben.
Befehle, die mit Pipe dahinter angegeben werden, würden jetzt als Bestandteil der URL gewertet werden.

\begin{lstlisting}[language=Bash, caption=Vereinfachtes Beispiel für HTTPS Delegate-Command nach dem Ersetzen der Platzhalter,label={lst:simpleexampleafter}]
"curl" "https:https://example.com/image.png|ls -la"
\end{lstlisting}
\vspace{5mm}

Da diese URL jedoch nicht valide ist, gibt der aufgerufene Delegate Command (meist curl oder wget) kein valides Bild zurück.\\

Der Parameter "`\%M"' wird nicht einfach abgeändert,
sondern bleibt in der vorherigen Form vorhanden, da noch andere Delegates, wie der "`mpeg:encode"'-Delegate auf ihn zugreifen.\\